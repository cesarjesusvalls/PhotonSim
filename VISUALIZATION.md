# PhotonSim Visualization Tool

Interactive 3D visualization for optical photon data generated by PhotonSim simulations.

## Features

- **3D Interactive Plotting**: Visualize optical photons in 3D space with detector geometry
- **Event Navigation**: Browse through simulation events with keyboard controls or interactive widgets
- **Color-coded Photons**: Photons are colored by creation time using a plasma colormap
- **Direction Vectors**: Sample of photon direction vectors displayed as arrows
- **Detector Geometry**: Wireframe visualization of the detector volume
- **Event Information**: Display primary particle energy and photon count
- **Dual Interface**: Works both in Jupyter notebooks (with widgets) and standalone (with keyboard controls)

## Installation

### Requirements

Install the required Python packages:

```bash
pip install uproot matplotlib numpy ipywidgets
```

Or use the provided requirements file:

```bash
pip install -r requirements.txt
```

### Dependencies

- **uproot**: For reading ROOT files without requiring ROOT installation
- **numpy**: For numerical operations
- **matplotlib**: For 3D plotting and visualization
- **ipywidgets**: For interactive controls in Jupyter notebooks (optional)

## Usage

### Command Line

```bash
# Basic usage - visualize first event
python visualize_photons.py optical_photons.root

# Start with specific event
python visualize_photons.py optical_photons.root --event 2

# Get help
python visualize_photons.py --help
```

### Interactive Controls

#### Standalone Mode (matplotlib)
- **Right Arrow / 'n'**: Next event  
- **Left Arrow / 'p'**: Previous event
- **'r'**: Refresh current event
- **Mouse**: Rotate, zoom, pan the 3D view

#### Jupyter Notebook Mode
- **Slider**: Select event number directly
- **Previous/Next Buttons**: Navigate between events
- **Interactive 3D plot**: Full matplotlib 3D interaction

### Jupyter Notebook

```python
from visualize_photons import PhotonSimVisualizer

# Create visualizer
viz = PhotonSimVisualizer('optical_photons.root')

# Create interactive interface (if in Jupyter)
viz.create_interactive_plot()

# Or plot specific event
viz.plot_event(event_id=1)
```

## Data Format

The visualization tool expects ROOT files with the following structure:

```
OpticalPhotons (TTree)
├── EventID (int): Event identification number
├── PrimaryEnergy (double): Primary particle energy [MeV]
├── NOpticalPhotons (int): Number of optical photons in event
├── PhotonPosX (vector<double>): X positions [mm]
├── PhotonPosY (vector<double>): Y positions [mm]  
├── PhotonPosZ (vector<double>): Z positions [mm]
├── PhotonDirX (vector<double>): X direction components
├── PhotonDirY (vector<double>): Y direction components
├── PhotonDirZ (vector<double>): Z direction components
└── PhotonTime (vector<double>): Creation times [ns]
```

## Visualization Elements

### Photon Display
- **Points**: Each optical photon is represented as a small colored point
- **Colors**: Plasma colormap representing creation time (purple=early, yellow=late)
- **Size**: Optimized for visibility while handling large datasets
- **Transparency**: Alpha blending to see overlapping photons

### Direction Vectors
- **White Arrows**: Sample of photon direction vectors (max 500 per event)
- **Scale**: Arrows scaled to 0.2m length for visibility
- **Sampling**: Random selection to avoid visual clutter

### Detector Geometry
- **Cyan Wireframe**: Outline of the detector volume
- **Automatic Sizing**: Detector size estimated from photon positions
- **Coordinate System**: Centered at origin (0,0,0)

### Primary Particle
- **Red Star**: Marks the primary particle origin at (0,0,0)
- **Reference Point**: Shows where the high-energy electron started

## Performance

### Large Datasets
- **Efficient Loading**: Uses uproot for fast ROOT file reading
- **Memory Management**: Loads all events at once for smooth navigation
- **Rendering Optimization**: Limits arrow count to maintain responsiveness

### Typical Performance
- **~200k photons**: Smooth interaction on modern hardware
- **Multiple events**: Instant switching between events
- **3D Rendering**: Real-time rotation and zooming

## Examples

### Basic Visualization
```bash
# Generate data with PhotonSim
./PhotonSim

# Visualize the results
python visualize_photons.py optical_photons.root
```

### Sample Output
```
Creating PhotonSim visualizer for optical_photons.root
Loaded 3 events from optical_photons.root
Total optical photons: 195,357
Average primary energy: 178.6 MeV
Estimated detector size: ±2.5 m
```

### Event Information Display
Each event shows:
- Event ID and primary particle energy
- Total number of Cherenkov photons generated
- 3D distribution of photon creation points
- Color-coded timeline of photon generation

## Technical Details

### Coordinate System
- **Units**: Positions converted from mm to m for display
- **Origin**: Primary particle starts at (0, 0, 0)
- **Direction**: Default beam along +Z axis
- **Detector**: Cubic volume centered at origin

### Color Mapping
- **Colormap**: Plasma (purple → pink → yellow)
- **Normalization**: Times normalized to [0,1] range per event
- **Fallback**: Uniform yellow if all times are identical

### File Format Support
- **ROOT Files**: Native support via uproot
- **Cross-Platform**: No ROOT installation required
- **Version Compatible**: Works with ROOT files from any version

## Troubleshooting

### Common Issues

1. **"uproot not available"**
   ```bash
   pip install uproot
   ```

2. **"ROOT file not found"**
   - Check file path and permissions
   - Ensure PhotonSim generated the file successfully

3. **"No events found"**
   - Verify PhotonSim ran with `/run/beamOn N` command
   - Check that optical photons were actually generated

4. **Slow performance**
   - Reduce number of events or photons per event
   - Use `--event` to start with specific event

### Debug Mode
```python
# Enable detailed information
viz = PhotonSimVisualizer('optical_photons.root')
print(f"Events: {viz.n_events}")
print(f"Data keys: {list(viz.data.keys())}")
```

## Integration

### Workflow Integration
1. **Run PhotonSim**: Generate optical photon data
2. **Analyze Results**: Use this tool for visual inspection
3. **Export Data**: Extract specific events or statistics
4. **Publication**: Generate high-quality plots for papers

### Custom Analysis
```python
# Access raw data for custom analysis
viz = PhotonSimVisualizer('optical_photons.root')
event_data = viz.get_event_data(event_id=0)

# Extract photon positions for analysis
positions = np.column_stack([
    event_data['pos_x'],
    event_data['pos_y'], 
    event_data['pos_z']
])
```

## License

Part of the PhotonSim project. See main repository for licensing information.